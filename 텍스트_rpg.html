<!DOCTYPE html>
<html lang="ko">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>텍스트 RPG</title>

		<style>
			:root {
				--healBar-width: 100%;
				--userHealth-width: 100%;
				--monsterHealth-width: 100%;
			}
			* {
				padding: 0;
				margin: 0;
				box-sizing: border-box;
			}
			ul,
			ol {
				list-style: none;
			}
			button:focus,
			input:focus {
				outline: none;
			}
			button {
				cursor: pointer;
			}
			img {
				width: 100%;
			}

			main {
				margin: 30px auto 0;
				padding: 30px;
				max-width: 1280px;
				height: 54vw;
			}

			.login {
				display: none;
				width: 100%;
				height: 100%;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				gap: 3vw;
			}
			.login.active {
				display: flex;
			}
			.login label {
				font-size: 5vw;
			}
			.login input {
				width: 80%;
				height: 8vw;
				padding: 0 10px;
				font-size: 4vw;
			}
			.login button {
				width: 15vw;
				height: 8vw;
				font-size: 4vw;
			}

			.town,
			.heal,
			.adventure {
				display: none;
				width: 100%;
				height: 100%;
				background: url(./img/rpg_village.jpg) no-repeat center/cover;
				position: relative;
			}
			.town.active,
			.heal.active,
			.adventure.active {
				display: block;
			}
			.town .user,
			.heal .user {
				position: absolute;
				bottom: 0;
				left: 50%;
				width: 40vw;
				margin-left: -20vw;
			}

			.town .menu {
				position: absolute;
				top: 0;
				left: 0;
				background: #eee;
				border-bottom-right-radius: 10px;
				overflow: hidden;
			}
			.town .menu li:not(:last-child) {
				border-bottom: 1px solid #fff;
			}
			.town .menu li button {
				width: 100%;
				padding: 0 3vw;
				font-size: 3vw;
				line-height: 2;
				border: none;
				text-align: center;
			}
			.town .menu button:hover {
				background: #ddd;
			}
			.town .info {
				position: absolute;
				top: 0;
				right: 0;
				background: #eee;
				border-bottom-left-radius: 10px;
				padding: 2vw 0;
			}
			.town .info li {
				padding: 0 3vw;
				font-size: 3vw;
				line-height: 1.5;
			}

			.heal {
				background-image: url(./img/rpg_bed.jpg);
			}
			.heal .heal_bar {
				position: absolute;
				top: 2vw;
				left: 50%;
				width: 90%;
				height: 3vw;
				margin-left: -45%;
				background: #555;
				border-radius: 10px;
				overflow: hidden;
			}
			.heal .heal_bar::after {
				content: "";
				display: block;
				width: var(--healBar-width);
				height: 100%;
				background: red;
				position: absolute;
				top: 0;
				left: 0;
				transition: 0.4s;
			}

			.adventure {
				background-image: url(./img/rpg_forest.jpg);
			}
			.adventure .menu {
				position: absolute;
				top: 5px;
				right: 5px;
				display: flex;
				gap: 5px;
			}
			.adventure .menu button {
				padding: 0 3vw;
				font-size: 3vw;
				line-height: 2;
				border: 1px solid #fff;
				text-align: center;
				border-radius: 5px;
			}
			.adventure .menu button:hover {
				background: #ddd;
			}
			.adventure .monster,
			.adventure .user {
				width: 25vw;
				position: absolute;
				bottom: 0;
			}
			.adventure .user {
				right: 0;
			}
			.adventure .heal_bar {
				content: "";
				display: block;
				position: absolute;
				top: -2vw;
				left: 50%;
				transform: translate(-50%);
				width: 50%;
				height: 1vw;
				background-color: #555;
				border-radius: 10px;
				overflow: hidden;
			}
			.adventure .heal_bar::after {
				content: "";
				display: block;
				position: absolute;
				top: 0;
				left: 0;
				height: 100%;
				background-color: red;
			}
			.adventure .user .heal_bar::after {
				width: var(--userHealth-width);
			}
			.adventure .monster .heal_bar::after {
				width: var(--monsterHealth-width);
			}

			@media screen and (max-width: 768px) {
				main {
					height: 90vw;
				}
			}
		</style>
	</head>
	<body>
		<main>
			<form action="/" class="login active">
				<label for="userName">사용자 이름을 입력해 주세요.</label>
				<input type="text" name="userName" id="userName" />
				<button type="submit">확인</button>
			</form>

			<form action="/" class="town">
				<ul class="menu">
					<li><button data-value="adventure">모험 떠나기</button></li>
					<li><button data-value="heal">휴식 하기</button></li>
					<li><button data-value="exit">게임 종료</button></li>
				</ul>

				<ul class="info">
					<li>이름: <span id="name"></span></li>
					<li>레벨: Lv<span id="level">1</span></li>
					<li>체력: <span id="health">100</span>%</li>
					<li>경험치: <span id="xp">0</span>/<span id="max-xp">15</span></li>
					<li>공격력: <span id="att">15</span></li>
				</ul>

				<div class="user">
					<img src="./img/rpg_user.png" alt="캐릭터 이미지" />
				</div>
			</form>

			<div class="heal">
				<div class="heal_bar"></div>
				<div class="user">
					<img src="./img/rpg_user.png" alt="캐릭터 이미지" />
				</div>
			</div>

			<form action="/" class="adventure">
				<ul class="menu">
					<li><button data-value="run">도망가기</button></li>
					<li><button data-value="heal">회복하기</button></li>
					<li><button data-value="fight">싸우기</button></li>
				</ul>

				<div class="monster">
					<div class="heal_bar"></div>
					<img src="./img/rpg_monster.png" alt="몬스터 이미지" />
				</div>

				<div class="user">
					<div class="heal_bar"></div>
					<img src="./img/rpg_user.png" alt="캐릭터 이미지" />
				</div>
			</form>

			<script>
				const $login = document.querySelector("form.login");
				const $town = document.querySelector("form.town");
				const $heal = document.querySelector(".heal");
				const $adventure = document.querySelector("form.adventure");
				const $monsterImg = document.querySelector(".monster img");

				const $userName = document.querySelector("#name");
				const $userLevel = document.querySelector("#level");
				const $userHealth = document.querySelector("#health");
				const $userXp = document.querySelector("#xp");
				const $userMaxXp = document.querySelector("#max-xp");
				const $userAtt = document.querySelector("#att");

				const user = {
					name: "",
					level: 1,
					health: 100,
					maxXp: 15,
					xp: 0,
					att: 3,
				};
				const monsterList = [
					{
						name: "monster",
						health: 100,
						xp: 15 * user.level,
						att: 5,
					},
					{
						name: "monster2",
						health: 100,
						xp: 20 * user.level,
						att: 10,
					},
					{
						name: "monster3",
						health: 100,
						xp: 10 * user.level,
						att: 3,
					},
				];

				let monster;
				let clickable = true;
				let monsterHealth = 100;

				function setHealTime(onetime = false) {
					document.documentElement.style.setProperty(
						"--healBar-width",
						`${user.health}%`
					);

					const healing = setInterval(() => {
						user.health = Math.min(100, user.health + (onetime ? 50 : 10));
						document.documentElement.style.setProperty(
							"--healBar-width",
							`${user.health}%`
						);
						$userHealth.textContent = user.health;

						if (onetime) {
							clearInterval(healing);
							$heal.classList.remove("active");
							$adventure.classList.add("active");
							return;
						}
						if (user.health >= 100) {
							clearInterval(healing);
							$heal.classList.remove("active");
							$town.classList.add("active");
							return;
						}
					}, 200);
				}

				function attack(target) {
					if (target === "user") {
						user.health = Math.max(0, user.health - monster.att);
						document.documentElement.style.setProperty(
							"--userHealth-width",
							`${user.health}%`
						);
						$userHealth.innerText = user.health;
						clickable = true;
					} else if (target === "monster") {
						monster.health = Math.max(0, monster.health - user.att);
						document.documentElement.style.setProperty(
							"--monsterHealth-width",
							`${monster.health}%`
						);
					}
				}

				function setMonster() {
					monster = JSON.parse(
						JSON.stringify(monsterList[+Math.floor(Math.random() * 2 + 1)])
					);
					$monsterImg.setAttribute("src", `./img/rpg_${monster.name}.png`);
					document.documentElement.style.setProperty(
						"--monsterHealth-width",
						`${monster.health}%`
					);
				}

				$login.addEventListener("submit", (e) => {
					e.preventDefault();

					const target = e.target;
					const targetValue = target.querySelector("input").value;

					if (!targetValue) {
						return;
					}

					user.name = targetValue;
					$userName.textContent = user.name;
					target.classList.remove("active");
					$town.classList.add("active");
					target.querySelector("input").value = "";
				});

				$town.addEventListener("click", (e) => {
					e.preventDefault();

					const targetValue = e.target.getAttribute("data-value");

					if (targetValue === null) {
						return;
					}

					if (targetValue === "adventure") {
						// 모험 모드
						$adventure.classList.add("active");
						setMonster();
						clickable = true;
					} else if (targetValue === "heal") {
						// 힐링 모드
						$heal.classList.add("active");
						setHealTime();
					} else if (targetValue === "exit") {
						// 게임 종료
						$login.classList.add("active");
					}

					$town.classList.remove("active");
				});

				$adventure.addEventListener("click", (e) => {
					e.preventDefault();

					const targetValue = e.target.getAttribute("data-value");

					if (targetValue == null || !clickable) {
						return;
					}

					if (targetValue === "run") {
						// 도망가기
						$town.classList.add("active");
						$adventure.classList.remove("active");
					} else if (targetValue === "heal") {
						// 회복하기
						setHealTime(true);
						$heal.classList.add("active");
						$adventure.classList.remove("active");
						setTimeout(() => attack("user"), 200);
					} else if (targetValue === "fight") {
						// 싸우기
						clickable = false;
						attack("monster");
						const userAttack = setTimeout(() => attack("user"), 200);

						if (user.health <= 0) {
							alert("적에게 당했습니다. 마을로 돌아갑니다.");
							$town.classList.add("active");
							$adventure.classList.remove("active");
						} else if (monster.health <= 0) {
							clearTimeout(userAttack);
							setTimeout(() => {
								const goTown = confirm(
									`적을 물리치고 공격력: ${monster.xp}, 경험치: ${monster.att}가 상승하였습니다. \n마을로 돌아가시겠습니까?`
								);

								user.att += monster.xp;
								user.xp += monster.att;

								if (goTown) {
									$town.classList.add("active");
									$adventure.classList.remove("active");
								} else {
									setMonster();
									clickable = true;
								}

								if (user.xp >= user.maxXp) {
									user.level += 1;
									user.xp = user.maxXp - user.xp;
									user.maxXp += 15;
								}

								$userLevel.textContent = user.level;
								$userXp.textContent = user.xp;
								$userMaxXp.textContent = user.maxXp;
								$userAtt.textContent = user.att;
							}, 400);
						}
					}
				});
			</script>
		</main>
	</body>
</html>
